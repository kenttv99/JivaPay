# План рефакторинга admin_app

## Анализ текущего состояния

### Выявленные проблемы и особенности:

1. **Заглушки данных:**
   - Все данные в приложении статичные (mock data)
   - Отсутствует интеграция с бэкенд API
   - Нет реальной аутентификации
   - Отсутствует управление состоянием приложения

2. **UI компоненты:**
   - Карточки с метриками дублируются на страницах dashboard, finance, charts
   - Фильтры с одинаковой структурой на всех страницах
   - Таблицы с идентичной пагинацией
   - Inline стили вместо использования ui-kit компонентов

3. **Логика:**
   - Логика пагинации повторяется в каждой таблице
   - Форматирование валют и дат дублируется
   - Обработка статусов с цветовой кодировкой

4. **Архитектурные недостатки:**
   - Отсутствуют переиспользуемые компоненты в src/components/
   - Нет хуков для общей логики
   - Не используется готовый ui-kit
   - Отсутствуют TypeScript типы
   - Нет сервисов для работы с API
   - Отсутствует конфигурация для работы с реальным бэкендом

## Анализ бэкенд API (из README_MAIN_BACKEND.md)

### Доступные сервисы для admin_app:
- **user_service**: Управление пользователями, ролями, профилями
- **permission_service**: Проверка гранулярных прав доступа
- **order_service**: Работа с историей ордеров и статистикой
- **merchant_service**: Управление мерчантами и магазинами
- **trader_service**: Статистика и управление трейдерами
- **platform_service**: Агрегированные балансы платформы
- **requisite_service**: Управление реквизитами
- **audit_service**: Аудит действий в системе

### API роутеры:
- `/admin/*` - административные эндпоинты
- `/common/*` - общие эндпоинты (orders, stores и т.д.)
- JWT авторизация с ролевой моделью

### Типы данных:
- Pydantic схемы для валидации
- SQLAlchemy модели
- Enum для статусов и типов

## План действий по рефакторингу

### Этап 1: Подготовка инфраструктуры API

1. **Создать структуру папок согласно архитектуре:**
   ```
   src/
     components/
       ui/           # Кастомные UI компоненты для admin_app
       features/     # Бизнес-компоненты (формы, таблицы данных)
       widgets/      # Составные блоки (дашборд виджеты)
     hooks/          # Переиспользуемые хуки (API, состояние)
     types/          # TypeScript типы (API схемы, енумы)
     utils/          # Вспомогательные функции
     services/       # API клиенты и сервисы
     contexts/       # React контексты (аутентификация, темы)
     config/         # Конфигурация приложения
   ```

2. **Настроить конфигурацию API:**
   - Создать `.env.local` с переменными окружения
   - Настроить базовые URL для API (admin, common эндпоинты)
   - Конфигурация для JWT токенов

3. **Создать базовые TypeScript типы из бэкенда:**
   - Типы пользователей (User, Admin, Merchant, Trader)
   - Типы ордеров (IncomingOrder, OrderHistory)
   - Типы статусов и енумы
   - API response/request типы

### Этап 2: Создание API сервисов

1. **auth.service.ts** - аутентификация и авторизация
   - Логин/логаут
   - Обновление токенов
   - Проверка прав доступа

2. **api.client.ts** - базовый HTTP клиент
   - Axios конфигурация
   - Перехватчики для токенов
   - Обработка ошибок

3. **Сервисы для каждого домена:**
   - **users.service.ts** - управление пользователями
   - **orders.service.ts** - работа с ордерами
   - **merchants.service.ts** - управление мерчантами
   - **traders.service.ts** - управление трейдерами
   - **platform.service.ts** - платформенная статистика
   - **audit.service.ts** - логи аудита

### Этап 3: Управление состоянием

1. **AuthContext** - контекст аутентификации
   - Текущий пользователь
   - Права доступа
   - Состояние авторизации

2. **useAuth** - хук для работы с авторизацией
3. **useApi** - хук для API запросов с обработкой ошибок
4. **usePermissions** - хук для проверки прав

### Этап 4: Создание переиспользуемых компонентов

1. **MetricCard** - карточка с метрикой (интеграция с platform.service)
2. **DataTable** - универсальная таблица с серверной пагинацией
3. **FilterPanel** - панель фильтров с привязкой к API
4. **StatusBadge** - бейдж статуса согласно бэкенд енумам
5. **LoadingStates** - компоненты состояний загрузки
6. **ErrorBoundary** - обработка ошибок приложения

### Этап 5: Создание хуков для данных

1. **useUsers** - получение и управление пользователями
2. **useOrders** - работа с ордерами (фильтры, пагинация)
3. **useMerchants** - управление мерчантами
4. **useTraders** - управление трейдерами
5. **usePlatformStats** - статистика платформы
6. **usePagination** - серверная пагинация
7. **useFilters** - управление фильтрами с синхронизацией URL

### Этап 6: Рефакторинг страниц с интеграцией API

1. **app/layout.tsx** - добавить AuthProvider, настроить глобальные стили
2. **page.tsx (Dashboard)** - подключить реальные метрики через usePlatformStats
3. **users/page.tsx** - интеграция с users.service через useUsers
4. **finance/page.tsx** - подключить financial данные
5. **charts/page.tsx** - интеграция аналитических данных
6. **stores/page.tsx** - управление магазинами через merchants.service
7. **settings/page.tsx** - системные настройки

### Этап 7: Безопасность и оптимизация

1. **Защищённые маршруты** - проверка авторизации и прав
2. **Error handling** - централизованная обработка ошибок API
3. **Loading states** - состояния загрузки для лучшего UX
4. **Caching** - кэширование API запросов (React Query/SWR)
5. **Оптимизация** - lazy loading, мемоизация компонентов

## Ожидаемые результаты

- **Полная интеграция с бэкенд API**
- **Реальная аутентификация и авторизация**
- **Динамические данные вместо заглушек**
- **Сокращение дублирующегося кода на ~60-70%**
- **Типобезопасность с TypeScript**
- **Переиспользуемые компоненты и хуки**
- **Единообразный UI/UX с ui-kit**
- **Масштабируемая архитектура**
- **Готовность к подключению реальных данных**

## Приоритеты выполнения

1. **Критический:** API конфигурация, типы данных, auth сервис
2. **Высокий:** API сервисы, AuthContext, базовые хуки
3. **Средний:** Переиспользуемые компоненты, интеграция страниц
4. **Низкий:** Оптимизация, кэширование, документация

## Специфические для admin_app требования

### Функциональные требования:
- **Управление пользователями**: CRUD операции для всех ролей
- **Статистика платформы**: Реальные метрики и аналитика
- **Управление ордерами**: Просмотр, фильтрация, модерация
- **Аудит системы**: Логи действий и системных событий
- **Конфигурация**: Управление настройками платформы

### Технические требования:
- **Права доступа**: Интеграция с permission_service
- **Безопасность**: JWT токены, защищённые маршруты
- **Производительность**: Серверная пагинация, ленивая загрузка
- **UX**: Loading states, error handling, optimistic updates

## Текущий прогресс

### ✅ Выполнено:- Анализ архитектуры платформы и референсного приложения- Создание базовой структуры папок- **Обновление дашборда с элементами из референса:**  - Добавлены дополнительные карточки статистики (ордеры, реквизиты, конверсия, время)  - Создана заглушка для детальной истории ордеров  - Улучшена структура компонентов- Создан компонент RecentOrders с детализацией- **Созданы переиспользуемые UI компоненты:**  - StatusBadge - универсальные статусные бейджи  - DataTable - переиспользуемая таблица с конфигурируемыми колонками  - TabGroup - компонент для табов с счетчиками  - StatsCard - карточки статистики с трендами и иконками- **Полностью переделана страница пользователей:**  - Использована табовая структура по ролям (админы, мерчанты, трейдеры, саппорт, тимлиды)  - Интегрированы новые компоненты DataTable и StatusBadge  - Добавлены специфичные для каждой роли колонки- **Полностью переделана страница финансов:**  - Использован компонент FinanceManagement с StatsCard  - Интегрированы фильтры и таблица транзакций  - Добавлено форматирование валют и статусов### 🔄 В процессе:- Создание типов данных для интеграции с API### ⏳ В очереди:- Создание API сервисов- Интеграция аутентификации- Подключение реальных данных### ✅ Недавно завершено:- **Полностью переделана страница аналитики (Charts):**  - Создан компонент AnalyticsManagement с фильтрами и статистикой  - Добавлены заглушки для графиков с детальными данными  - Интегрированы StatsCard и DataTable- **Полностью переделана страница магазинов (Stores):**  - Создан компонент StoreManagement с топ-списком магазинов  - Добавлены фильтры по статусу и категории  - Интегрированы все переиспользуемые компоненты- **Полностью переделана страница настроек (Settings):**  - Создан компонент SettingsManagement с табовой структурой  - Добавлены разделы: Система, Безопасность, Информация  - Включены системные настройки, параметры безопасности и мониторинг
