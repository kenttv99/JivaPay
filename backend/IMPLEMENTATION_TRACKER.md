# Трекер Реализации Backend

Этот документ отслеживает прогресс реализации компонентов бэкенда, как описано в `README_IMPLEMENTATION_PLAN.md`.

Используйте флажки для отметки статуса каждой задачи:
- [ ] Не начато
- [x] Готово
- [/] В процессе (Опционально, при необходимости)

Добавляйте комментарии, ссылки на PR или соответствующие хэши коммитов в раздел "Примечания" для каждого пункта.

---

## 1. Настройка Проекта и Базовая Инфраструктура

- [ ] **Настройка Alembic (`alembic/`)**:
    - Примечания:
- [ ] **Начальные миграции БД**: На основе `README_DB.md` (Пользователи, Роли, Реквизиты, Ордера, Балансы, АудитЛог и т.д.).
    - Примечания:
- [ ] **Скрипт заполнения данных (`scripts/seed_data.py`)**: Для начальных ролей, пользователя-админа, справочных данных.
    - Примечания:
- [ ] **Конфигурация (`config/`)**: Обработка переменных окружения (`pydantic-settings`).
    - Примечания:
- [ ] **Настройка Логирования (`logger.py`)**: Базовая конфигурация структурированного логирования.
    - Примечания:
- [ ] **Движок БД и Сессия (`engine.py`)**: Настройка `SessionLocal`.
    - Примечания:
- [ ] **Основные Модели (`models/`)**: Модели SQLAlchemy на основе `README_DB.md`.
    - Примечания:
- [ ] **Базовые Схемы (`schemas/base.py`, `schemas/user.py`, и т.д.)**: Схемы Pydantic для передачи данных API.
    - Примечания:
- [ ] **Базовое Приложение FastAPI (`main.py`)**: Начальная настройка приложения, включить эндпоинт проверки состояния.
    - Примечания:
- [ ] **Управление Зависимостями (`requirements.txt` или `pyproject.toml`)**: Список начальных зависимостей.
    - Примечания:
- [ ] **Стратегия Управления Секретами**: Определить подход (например, HashiCorp Vault, AWS Secrets Manager, переменные окружения для разработки).
    - Примечания:
- [ ] **Настройка Объектного Хранилища (например, S3)**: Настроить клиент/учетные данные при необходимости для загрузки/хранения файлов.
    - Примечания:

## 2. Аутентификация и Авторизация

- [ ] **Реализация JWT/OAuth2 (`auth/`)**:
    - [ ] Утилиты генерации/валидации токенов (`auth/utils.py`).
    - [ ] Хеширование паролей (`passlib`).
    - [ ] Зависимости FastAPI Security (`auth/dependencies.py`).
    - Примечания:
- [ ] **Эндпоинт Логина (`api_routers/auth_router.py`)**: Реализовать эндпоинт `/token`.
    - Примечания:
- [ ] **Защита Эндпоинтов**: Применить зависимости для защиты эндпоинтов на основе ролей.
    - Примечания:

## 3. Основные Сервисы (`services/`)

- [ ] **Утилиты работы с БД (`backend/database/utils.py`)**: Функции для безопасного доступа и транзакций с базой данных (CRUD, atomic_transaction, get_db_session).
- [ ] **Сервис Пользователей (`services/user_service.py`)**: Логика управления пользователями и ролями (CRUD, авторизация).
- [ ] **Сервис Подбора Реквизитов (`services/requisite_selector.py`)**: Логика поиска и выбора подходящих реквизитов для incoming orders.
- [ ] **Сервис Обработки Заявок (`services/order_processor.py`)**: Оркестрация обработки входящих заявок, подбор реквизитов, создание OrderHistory.
- [ ] **Сервис Обновления Балансов (`services/balance_manager.py`)**: Надежное обновление балансов и запись истории после подтверждения ордеров.
- [ ] **Сервис Справочных Данных (`services/reference_data.py`)**: Доступ к справочным данным (banks, payment_methods, currencies) с кэшированием.
- [ ] **Менеджер Статусов Ордера (`services/order_status_manager.py`)**: Управление переходами статусов ордеров (confirm, cancel, dispute).
- [ ] **Логгер Аудита (`services/audit_logger.py`)**: Сервис для записи событий аудита в AuditLog.
- [ ] **Детектор Мошенничества (`services/fraud_detector.py`)**: Правила и проверки для обнаружения мошеннических операций.
- [ ] **Утилиты Исключений (`backend/utils/exceptions.py`)**: Определить иерархию кастомных исключений.
- [ ] **Утилиты Оповещений (`backend/utils/notifications.py`)**: Настроить отправку оповещений о критических ошибках (Sentry).

## 4. API Роутеры (`api_routers/`)

- [ ] **Роутер Аутентификации (`api_routers/auth_router.py`)**: Эндпоинт логина/токена.
    - Примечания:
- [ ] **Роутер Мерчанта (`api_routers/merchant_router.py`)**: Эндпоинты для мерчантов (создать ордер, просмотреть ордера, просмотреть баланс).
    - Примечания:
- [ ] **Роутер Трейдера (`api_routers/trader_router.py`)**: Эндпоинты для трейдеров (просмотр назначенных ордеров, управление реквизитами, подтверждение/оспаривание ордеров).
    - Примечания:
- [ ] **Роутер Администратора (`api_routers/admin_router.py`)**: Эндпоинты для админов (управление пользователями, обзор ордеров, корректировка балансов, утверждения).
    - Примечания:
- [ ] **Публичный Роутер/Роутер Справочников (`api_routers/public_router.py`)**: Эндпоинты для справочных данных (валюты, методы оплаты).
    - Примечания:
- [ ] **Роутер Шлюза (`api_routers/gateway.py`)**: Эндпоинты для PayIn/PayOut шлюза.

## 5. Фоновый Воркер (`worker/`)

- [ ] **Настройка Celery/RQ (`worker/main.py`, `worker/tasks.py`)**: Настроить очередь задач и процесс воркера.
    - Примечания:
- [ ] **Задача Обработчика Ордеров (`worker/tasks.py:process_order_task`)**: Задача для обработки `IncomingOrder`.
    - [ ] Проверка идемпотентности.
    - [ ] Вызов подбора реквизита.
    - [ ] Создание `MatchedOrder`.
    - [ ] Надежные обновления статуса (`retrying`/`failed`) при ошибках (отдельная транзакция).
    - Примечания:
- [ ] **Задача Обновления Баланса (Опционально - `worker/tasks.py:update_balance_task`)**: Если используются асинхронные обновления через очередь задач/транзакционный outbox.
    - Примечания:
- [ ] **Настройка Очереди Недоставленных Сообщений (DLQ)**: Настроить DLQ для неудавшихся задач.
    - Примечания:

## 6. Middleware (`middleware/`)

- [ ] **Middleware Логирования Запросов**: Логировать входящие запросы.
    - Примечания:
- [ ] **Middleware Обработки Ошибок**: Централизованная обработка исключений, маппинг на HTTP ошибки.
    - Примечания:
- [ ] **Ограничение Частоты Запросов (`slowapi` + Redis)**: Реализовать ограничение по IP.
    - Примечания:

## 7. Тестирование

- [ ] **Юнит-тесты (`tests/unit/`)**: Для сервисов, утилит, сложной логики.
    - Примечания:
- [ ] **Интеграционные тесты (`tests/integration/`)**: Тестирование взаимодействий между сервисами, API эндпоинтами, БД.
    - Примечания:
- [ ] **Профилирование Индексов БД**: Анализ производительности запросов под нагрузкой.
    - Примечания:

## 8. Развертывание и Эксплуатация

- [ ] **Dockerfile**: Контейнеризация приложения.
    - Примечания:
- [ ] **Настройка CI/CD Пайплайна**: Автоматические тесты, линтинг, сборка, развертывание.
    - Примечания:
- [ ] **Настройка Инфраструктуры Мониторинга/Логирования**: Интеграция Prometheus/Grafana, ELK/Loki stack.
    - Примечания:
- [ ] **Стратегия Развертывания Без Простоя**: Определить подход (например, blue-green, canary).
    - Примечания:

## 9. Документация

- [ ] **Документация API (Авто-генерируемая)**: Убедиться, что спецификация OpenAPI точна и удобна для пользователя.
    - Примечания:
- [ ] **Обновления README**: Поддерживать файлы документации (`README_DB.md`, `README_COMPONENTS.md`, и т.д.) в актуальном состоянии.
    - Примечания:

---

*Не забывайте обновлять этот трекер по мере выполнения задач.* 