# Справочник компонентов бэкенда

В этом документе перечислены ключевые компоненты серверной части JivaPay, их назначение и расположение в проекте.

## 1. API-роутеры (`backend/api_routers`)
- `admin` — эндпоинты администратора (логин, управление пользователями, регистрация, отладка Celery).
- `merchant` — операции мерчанта (логин, создание/просмотр ордеров).
- `trader` — операции трейдера (логин, подтверждение/отмена ордеров).
- `support` — операции саппорта (логин, поиск и просмотр ордеров и пользователей).
- `teamlead` — операции тимлида (логин, управление трафиком трейдеров, статистика).
- `gateway` — публичный шлюз Pay-In/Pay-Out (инициация, статус, подтверждение).
- `public_router.py` — справочные данные (валюты, методы оплаты, курсы).

## 2. Модели и ORM (`backend/database`)
- `db.py` — основные SQLAlchemy-модели (`User`, `MerchantStore`, `Trader`, `OrderHistory` и др.).
- `utils.py` — утилиты работы с сессией (get_db_session, atomic_transaction, CRUD-функции).
- `migrations/` — скрипты Alembic для регистраций и изменений схемы БД.

## 3. Сервисы (`backend/services`)
- `user_service.py` — логика работы с пользователями и ролями.
- `order_processor.py` — оркестрация обработки входящих ордеров.
- `balance_manager.py` — расчет и обновление балансов.
- `reference_data.py` — кэширование и выдача справочных данных.
- `requisite_selector.py` — подбор подходящих реквизитов.
- `order_status_manager.py` — подтверждение и отмена ордеров.
- `audit_logger.py` — запись событий аудита.
- `fraud_detector.py` — проверки анти-фрода.
- `gateway_service.py` — логика публичного API-шлюза.
- `callback_service.py` — отправка коллбэков мерчантам.

## 4. Утилиты и скрипты (`backend/utils`, `backend/scripts`)
- `utils/exceptions.py` — кастомные исключения.
- `utils/config_loader.py` — чтение и типизация настроек из БД.
- `utils/notifications.py` — отправка оповещений о критических ошибках.
- `utils/s3_client.py` — работа с S3 (MinIO).
- `scripts/seed_config.py` — сидирование конфигураций.
- `scripts/seed_data.py` — сидирование ролей и администратора.
- `scripts/init_db.py` — инициализация схемы БД без миграций.

## 5. Фоновый воркер (`backend/worker`)
- `app.py` — настройка Celery (broker, backend, очереди).
- `tasks.py` — задачи обработки ордеров и балансов.
- `scheduler.py` — планировщик задач (при необходимости).

## 6. Middleware и основные настройки (`backend/middleware`, `backend/config`)
- `middleware/rate_limiting.py` — ограничение частоты запросов.
- `config/settings.py` — Pydantic Settings для конфигурации приложения.
- `servers/*/server.py` — точки входа FastAPI (подключение middleware, роутеров).

## 7. Docker и развертывание
- `Dockerfile` — контейнеризация приложения.
- `docker-compose.yml` — локальная разработка и тестирование всех сервисов.

## 1. Общая структура

Директория `backend` реализует серверную логику для различных ролей (мерчант, трейдер, саппорт, админ) и содержит вспомогательные модули для работы с БД, логированием, криптографией, конфигами и API-роутерами.

**Важное требование безопасности:** Вся внешняя коммуникация с API бэкенда (от фронтенда, от API мерчантов) **должна** осуществляться исключительно по протоколу **HTTPS**.

---

## 2. Компоненты

### 2.1. `database/`

*   **engine.py**
    *   Инициализация SQLAlchemy engine и сессии.
    *   Использует переменные окружения для подключения к PostgreSQL.
    *   Экспортирует: `engine`, `SessionLocal`.
*   **migrations/**
    *   Скрипты Alembic для миграций схемы БД.
*   **db.py** (Определяет `Base` и все модели таблиц БД, включая `Merchant`, `Trader`, `IncomingOrder`, `OrderHistory` и другие; модели подробно описаны в `README_DB.md`)

### 2.2. `config/`

*   **logger.py**
    *   Универсальный логгер (консоль/файл).
    *   **Рекомендация:** Настроить форматтер для вывода логов в структурированном виде (например, JSON).
    *   Экспортирует: `get_logger`.
*   **crypto.py**
    *   Функции для хеширования и проверки паролей (bcrypt).
    *   Экспортирует: `hash_password`, `verify_password`.
*   **settings.py** (Или аналогичный, например, чтение из `.env`)
    *   Загрузка и предоставление доступа к настройкам приложения (строка подключения к БД, секретные ключи, параметры API, настройки Worker'а, Redis URL, Sentry DSN, ключи S3 и т.д.).

### 2.3. `servers/`

*   **Назначение:** Содержит точки входа (FastAPI приложения) для каждой роли.
*   **Структура:** Поддиректории `merchant/`, `trader/`, `admin/`, `support/`. В каждой - `server.py`, инициализирующий FastAPI `app` для этой роли.
*   **Взаимодействие:** Импортируют и монтируют соответствующие `APIRouter` из `api_routers/`, могут подключать специфичные для роли Middleware.

### 2.4. `api_routers/`

*   **Назначение:** Обработка входящих HTTP-запросов, валидация данных (с использованием схем Pydantic из `shemas_enums`), вызов соответствующей бизнес-логики из сервисов, формирование HTTP-ответов.
*   **Структура:** Разделены по ролям пользователей (`merchant`, `trader`, `admin`, `support`). Каждый роутер может содержать подмодули (например, `auth.py`, `stores.py` внутри `merchant/`).
*   **Взаимодействие:** Импортируют и используют сервисы (`services.*`), утилиты БД (`database.utils`), схемы (`shemas_enums.*`), утилиты безопасности (`security.py`), конфигурацию.

### 2.5. `shemas_enums/`

*   **Назначение:** Содержит Pydantic-модели (схемы) и Python Enums для валидации данных API запросов/ответов и типизации.
*   **Структура:** Могут быть разделены на файлы по ролям или сущностям (например, `merchant_schemas.py`, `order_schemas.py`, `common_enums.py`).
*   **Примеры:** Схемы для логина, регистрации, создания/обновления магазинов/реквизитов, представления ордеров, перечисления для статусов, ролей, типов ордеров.
*   **Взаимодействие:** Используются в `api_routers` для валидации и сериализации, а также могут использоваться в `services` для типизации.

### 2.6. `middleware/`

*   **Назначение:** Обработка запросов/ответов на сквозном уровне.
*   **Примеры:** Rate Limiting, CORS, логирование запросов.
*   **Реализация:** Функции или классы, совместимые с FastAPI.
*   **Подключение:** Регистрируются в `servers/*/server.py` или в общем `main.py`, если он есть.

### 2.7. `services/`

*   **Назначение:** Инкапсуляция основной бизнес-логики.
*   **Примеры:** `requisite_selector.py`, `order_processor.py`, `balance_manager.py`, `reference_data.py`, `order_status_manager.py`, `audit_logger.py`, `fraud_detector.py`.
*   **Взаимодействие:** Используют `database.utils`, модели (`database.*`), кастомные исключения (`utils.exceptions`), конфигурацию. Вызываются из `api_routers` или `worker`.

### 2.8. `utils/`

*   **Назначение:** Вспомогательные функции и классы общего назначения, не являющиеся основной бизнес-логикой.
*   **Примеры:** `exceptions.py` (кастомные исключения), `notifications.py` (отправка оповещений), `s3_client.py` (работа с S3), возможно, функции форматирования дат/чисел.

### 2.9. `worker/`

*   **Назначение:** Реализация фонового обработчика задач (например, на Celery или Dramatiq).
*   **Структура:** `app.py` (инициализация приложения Worker'а), `tasks.py` (определение задач), `scheduler.py` (логика запуска периодических задач).
*   **Взаимодействие:** Вызывает сервисы (`services.*`) для выполнения задач. Использует брокер сообщений (Redis/RabbitMQ).

### 2.10. `security.py` (В корне `backend/` или в `utils/`)

*   **Назначение:** Содержит функции и зависимости для аутентификации и авторизации (работа с JWT, проверка токенов, получение текущего пользователя).
*   **Взаимодействие:** Используется в `api_routers` через `Depends`.

### 2.11. `Платежный Шлюз (Payment Gateway)`

*   **Назначение:** Компонент, предоставляющий интерфейс (API и потенциально UI) для **конечных клиентов (покупателей) магазинов мерчантов**. Отвечает за:
    *   Отображение формы оплаты/выплаты.
    *   Прием данных от клиента (сумма, метод оплаты, ID клиента магазина).
    *   Инициацию создания `IncomingOrder` через вызов соответствующих сервисов.
    *   Отображение подобранных реквизитов клиенту.
    *   Прием подтверждения оплаты от клиента (включая загрузку чеков).
    *   Информирование клиента о статусе операции.
    *   Перенаправление клиента на `return_url` мерчанта.
    *   Отправку **коллбэков (webhooks)** на `callback_url` мерчанта для серверного уведомления об изменении статуса ордера.
    *   Взаимодействует с `services` (Order Service, Requisite Service, Status Manager), `utils` (S3 для чеков) и использует свой набор API-эндпоинтов, вероятно, не требующих стандартной аутентификации мерчанта/трейдера.

---

## 3. Вспомогательные файлы корневой директории `backend/`

*   **README_DB.md:** Документация по БД.
*   **README_COMPONENTS.md:** Этот файл.
*   **README_UTILITIES.md:** Описание логики сервисов.
*   **README_IMPLEMENTATION_PLAN.md:** План реализации.
*   **requirements.txt:** Основные зависимости.
*   **requirements_worker.txt:** (Опционально) Дополнительные зависимости для Worker'а.
*   **alembic.ini:** Конфигурация Alembic.
*   **.env / .env.example:** Файлы конфигурации/переменных окружения.
*   **__init__.py:** Обозначение корневого пакета.

---

Эта структура обеспечивает модульность и разделение ответственности между компонентами бэкенд-приложения.

## 3. Основные Технологии

*   **Язык:** Python 3.10+