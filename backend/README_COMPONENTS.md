# Документация по компонентам backend (кроме таблиц БД)

---

## 1. Общая структура

Директория `backend` реализует серверную логику для различных ролей (мерчант, трейдер, саппорт, админ) и содержит вспомогательные модули для работы с БД, логированием, криптографией, конфигами и API-роутерами.

**Важное требование безопасности:** Вся внешняя коммуникация с API бэкенда (от фронтенда, от API мерчантов) **должна** осуществляться исключительно по протоколу **HTTPS**.

---

## 2. Компоненты

### 2.1. `database/`

- **engine.py**  
  Инициализация SQLAlchemy engine и сессии.  
  Использует переменные окружения для подключения к PostgreSQL.  
  Экспортирует:  
  - `engine` — основной объект подключения к БД  
  - `SessionLocal` — фабрика сессий SQLAlchemy

- **migrations/**  
  Скрипты Alembic для миграций схемы БД.  
  Основные функции: `upgrade()`, `downgrade()`, запуск offline/online миграций.

- **__init__.py**  
  Пустой, для обозначения пакета.

### 2.2. `config/`

- **logger.py**  
  Универсальный логгер с поддержкой вывода в консоль и файл (через RotatingFileHandler).  
  Формат логов и уровень задаются через .env.  
  **Рекомендация:** Настроить форматтер для вывода логов в структурированном виде (например, JSON) для облегчения автоматизированного парсинга и анализа системами агрегации логов.  
  Основная функция:  
  - `get_logger(name, log_file, level)` — возвращает настроенный логгер.

- **crypto.py**  
  Функции для безопасного хеширования и проверки паролей с использованием bcrypt.  
  - `hash_password(password)` — возвращает bcrypt-хеш пароля.  
  - `verify_password(password, hashed_password)` — проверяет соответствие пароля хешу.

- **__init__.py**  
  Пустой, для обозначения пакета.

### 2.3. `servers/`

Каждая поддиректория реализует FastAPI-приложение для своей роли:

- **trader/server.py**  
  FastAPI-приложение для трейдеров.  
  Подключает роутер аутентификации трейдера (`/trader/auth/login`).

- **merchant/server.py**  
  FastAPI-приложение для мерчантов.  
  Подключает роутер аутентификации мерчанта (`/merchant/auth/login`).

- **support/server.py**  
  FastAPI-приложение для саппорта.  
  Подключает роутер аутентификации саппорта (`/support/auth/login`).

- **admin/server.py**  
  FastAPI-приложение для админов.  
  Подключает роутер регистрации мерчанта и саппорта (`/admin/register/merchant`, `/admin/register/support`).

### 2.4. `api_routers/`

- **trader/auth.py**  
  Роутер FastAPI для аутентификации трейдера.  
  - POST `/trader/auth/login` — логин по email и паролю.

- **merchant/auth.py**  
  Роутер FastAPI для аутентификации мерчанта.  
  - POST `/merchant/auth/login` — логин по email и паролю.

- **support/auth.py**  
  Роутер FastAPI для аутентификации саппорта.  
  - POST `/support/auth/login` — логин по email и паролю.

- **admin/register.py**  
  Роутер FastAPI для регистрации новых мерчантов и саппортов.  
  - POST `/admin/register/merchant` — регистрация мерчанта.  
  - POST `/admin/register/support` — регистрация саппорта.

### 2.5. `