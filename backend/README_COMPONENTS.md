# Документация по компонентам backend (кроме таблиц БД)

---

## 1. Общая структура

Директория `backend` реализует серверную логику для различных ролей (мерчант, трейдер, саппорт, админ) и содержит вспомогательные модули для работы с БД, логированием, криптографией, конфигами и API-роутерами.

**Важное требование безопасности:** Вся внешняя коммуникация с API бэкенда (от фронтенда, от API мерчантов) **должна** осуществляться исключительно по протоколу **HTTPS**.

---

## 2. Компоненты

### 2.1. `database/`

*   **engine.py**
    *   Инициализация SQLAlchemy engine и сессии.
    *   Использует переменные окружения для подключения к PostgreSQL.
    *   Экспортирует: `engine`, `SessionLocal`.
*   **migrations/**
    *   Скрипты Alembic для миграций схемы БД.
*   **db.py / models.py** (Предположительно, здесь должна быть Base и модели, хотя в `README_DB.md` они описаны без указания файла)
    *   Определение базового класса SQLAlchemy (`Base`) и всех моделей таблиц БД (Merchant, Trader, OrderHistory и т.д.).

### 2.2. `config/`

*   **logger.py**
    *   Универсальный логгер (консоль/файл).
    *   **Рекомендация:** Настроить форматтер для вывода логов в структурированном виде (например, JSON).
    *   Экспортирует: `get_logger`.
*   **crypto.py**
    *   Функции для хеширования и проверки паролей (bcrypt).
    *   Экспортирует: `hash_password`, `verify_password`.
*   **settings.py** (Или аналогичный, например, чтение из `.env`)
    *   Загрузка и предоставление доступа к настройкам приложения (строка подключения к БД, секретные ключи, параметры API, настройки Worker'а, Redis URL, Sentry DSN, ключи S3 и т.д.).

### 2.3. `servers/`

*   **Назначение:** Содержит точки входа (FastAPI приложения) для каждой роли.
*   **Структура:** Поддиректории `merchant/`, `trader/`, `admin/`, `support/`. В каждой - `server.py`, инициализирующий FastAPI `app` для этой роли.
*   **Взаимодействие:** Импортируют и монтируют соответствующие `APIRouter` из `api_routers/`, могут подключать специфичные для роли Middleware.

### 2.4. `api_routers/`

*   **Назначение:** Обработка входящих HTTP-запросов, валидация данных (с использованием схем Pydantic из `shemas_enums`), вызов соответствующей бизнес-логики из сервисов, формирование HTTP-ответов.
*   **Структура:** Разделены по ролям пользователей (`merchant`, `trader`, `admin`, `support`). Каждый роутер может содержать подмодули (например, `auth.py`, `stores.py` внутри `merchant/`).
*   **Взаимодействие:** Импортируют и используют сервисы (`services.*`), утилиты БД (`database.utils`), схемы (`shemas_enums.*`), утилиты безопасности (`security.py`), конфигурацию.

### 2.5. `shemas_enums/`

*   **Назначение:** Содержит Pydantic-модели (схемы) и Python Enums для валидации данных API запросов/ответов и типизации.
*   **Структура:** Могут быть разделены на файлы по ролям или сущностям (например, `merchant_schemas.py`, `order_schemas.py`, `common_enums.py`).
*   **Примеры:** Схемы для логина, регистрации, создания/обновления магазинов/реквизитов, представления ордеров, перечисления для статусов, ролей, типов ордеров.
*   **Взаимодействие:** Используются в `api_routers` для валидации и сериализации, а также могут использоваться в `services` для типизации.

### 2.6. `middleware/`

*   **Назначение:** Обработка запросов/ответов на сквозном уровне.
*   **Примеры:** Rate Limiting, CORS, логирование запросов.
*   **Реализация:** Функции или классы, совместимые с FastAPI.
*   **Подключение:** Регистрируются в `servers/*/server.py` или в общем `main.py`, если он есть.

### 2.7. `services/`

*   **Назначение:** Инкапсуляция основной бизнес-логики.
*   **Примеры:** `requisite_selector.py`, `order_processor.py`, `balance_manager.py`, `reference_data.py`, `order_status_manager.py`, `audit_logger.py`, `fraud_detector.py`.
*   **Взаимодействие:** Используют `database.utils`, модели (`database.*`), кастомные исключения (`utils.exceptions`), конфигурацию. Вызываются из `api_routers` или `worker`.

### 2.8. `utils/`

*   **Назначение:** Вспомогательные функции и классы общего назначения, не являющиеся основной бизнес-логикой.
*   **Примеры:** `exceptions.py` (кастомные исключения), `notifications.py` (отправка оповещений), `s3_client.py` (работа с S3), возможно, функции форматирования дат/чисел.

### 2.9. `worker/`

*   **Назначение:** Реализация фонового обработчика задач (например, на Celery или Dramatiq).
*   **Структура:** `app.py` (инициализация приложения Worker'а), `tasks.py` (определение задач), `scheduler.py` (логика запуска периодических задач).
*   **Взаимодействие:** Вызывает сервисы (`services.*`) для выполнения задач. Использует брокер сообщений (Redis/RabbitMQ).

### 2.10. `security.py` (В корне `backend/` или в `utils/`)

*   **Назначение:** Содержит функции и зависимости для аутентификации и авторизации (работа с JWT, проверка токенов, получение текущего пользователя).
*   **Взаимодействие:** Используется в `api_routers` через `Depends`.

### 2.11. `Платежный Шлюз (Payment Gateway)`

*   **Назначение:** Компонент, предоставляющий интерфейс (API и потенциально UI) для **конечных клиентов (покупателей) магазинов мерчантов**. Отвечает за:
    *   Отображение формы оплаты/выплаты.
    *   Прием данных от клиента (сумма, метод оплаты, ID клиента магазина).
    *   Инициацию создания `IncomingOrder` через вызов соответствующих сервисов.
    *   Отображение подобранных реквизитов клиенту.
    *   Прием подтверждения оплаты от клиента (включая загрузку чеков).
    *   Информирование клиента о статусе операции.
    *   Перенаправление клиента на `return_url` мерчанта.
    *   Отправку **коллбэков (webhooks)** на `callback_url` мерчанта для серверного уведомления об изменении статуса ордера.
    *   Взаимодействует с `services` (Order Service, Requisite Service, Status Manager), `utils` (S3 для чеков) и использует свой набор API-эндпоинтов, вероятно, не требующих стандартной аутентификации мерчанта/трейдера.

---

## 3. Вспомогательные файлы корневой директории `backend/`

*   **README_DB.md:** Документация по БД.
*   **README_COMPONENTS.md:** Этот файл.
*   **README_UTILITIES.md:** Описание логики сервисов.
*   **README_IMPLEMENTATION_PLAN.md:** План реализации.
*   **requirements.txt:** Основные зависимости.
*   **requirements_worker.txt:** (Опционально) Дополнительные зависимости для Worker'а.
*   **alembic.ini:** Конфигурация Alembic.
*   **.env / .env.example:** Файлы конфигурации/переменных окружения.
*   **__init__.py:** Обозначение корневого пакета.

---

Эта структура обеспечивает модульность и разделение ответственности между компонентами бэкенд-приложения.

## 3. Основные Технологии

*   **Язык:** Python 3.10+